#!/bin/bash

# This script generates a CSV report from JSON files and calculates averages.

DATA_DIR="pokemon_data"
REPORT_FILE="pokemon_report.csv"

if [ ! -d "$DATA_DIR" ] || [ -z "$(ls -A $DATA_DIR/*.json 2>/dev/null)" ]; then
    echo "Error: No JSON files found in $DATA_DIR directory." >&2
    exit 1
fi

# Create CSV header
echo "Name,Height (m),Weight (kg)" > "$REPORT_FILE"

# Process each JSON file
for file in "$DATA_DIR"/*.json; do
    # Use jq to extract data, create a CSV-formatted line, and capitalize the name
    jq -r '[.name, .height/10, .weight/10] | @csv' "$file" | \
    sed -E 's/^"([^"]+)"/\L\u\1/' | \
    sed 's/"//g' >> "$REPORT_FILE"
done

echo "CSV Report generated at: $REPORT_FILE"
echo ""
cat "$REPORT_FILE"

# Use awk to calculate and print averages, skipping the header line (NR>1)
awk -F',' '
NR > 1 {
    height_sum += $2
    weight_sum += $3
    count++
}
END {
    if (count > 0) {
        printf "\nAverage Height: %.2f m\n", height_sum/count
        printf "Average Weight: %.2f kg\n", weight_sum/count
    }
}' "$REPORT_FILE"